<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Canvas Auto Fetcher</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    #status { margin-bottom: 1rem; }
    #urls { white-space: pre-wrap; background: #f0f0f0; padding: 0.5rem; border-radius: 4px; max-height: 150px; overflow-y: auto; }
    video { margin-top: 1rem; max-width: 100%; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin-top: 1rem; }
    #loginBtn { background-color: #1DB954; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Tự động lấy Canvas Spotify</h1>

  <div id="loginSection">
    <button id="loginBtn">Đăng nhập Spotify</button>
  </div>

  <div id="mainSection" style="display:none;">
    <div id="status">Đang chuẩn bị...</div>
    <pre id="urls"></pre>
    <video id="canvasPlayer" controls loop muted></video>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
  <script>
  (async () => {
    const clientId = "de3674fcad564fa38411e53ceb915f6c";
    const redirectUri = window.location.origin + window.location.pathname;

    const loginBtn = document.getElementById("loginBtn");
    const loginSection = document.getElementById("loginSection");
    const mainSection = document.getElementById("mainSection");
    const statusEl = document.getElementById("status");
    const urlsEl = document.getElementById("urls");
    const canvasPlayer = document.getElementById("canvasPlayer");

    function getSpotifyLoginUrl() {
      const scopes = "user-read-private user-read-email user-read-playback-state";
      return `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&show_dialog=true`;
    }

    function getTokenFromUrl() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get("access_token");
    }

    function clearUrlHash() {
      history.replaceState("", document.title, window.location.pathname + window.location.search);
    }

    // Protobuf schema
    const root = protobuf.Root.fromJSON({
      nested: {
        com: {
          nested: {
            spotify: {
              nested: {
                canvazcache: {
                  nested: {
                    EntityCanvazResponse: {
                      fields: {
                        canvases: { rule: "repeated", type: "Canvaz", id: 1 },
                        ttlInSeconds: { type: "int64", id: 2 },
                      },
                      nested: {
                        Canvaz: {
                          fields: {
                            id: { type: "string", id: 1 },
                            url: { type: "string", id: 2 },
                            fileId: { type: "string", id: 3 },
                            type: { type: "int32", id: 4 },
                            entityUri: { type: "string", id: 5 },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          },
        },
      },
    });
    const EntityCanvazResponse = root.lookupType("com.spotify.canvazcache.EntityCanvazResponse");

    function encodeEntityCanvazRequest(trackUri) {
      const prefix = 0x0a;
      const uriBytes = new TextEncoder().encode(trackUri);
      const length = uriBytes.length + 2;
      return new Uint8Array([
        prefix, length,
        0x0a, uriBytes.length,
        ...uriBytes,
      ]);
    }

    async function fetchCanvasUrls(token, trackId) {
      const trackUri = `spotify:track:${trackId}`;
      const body = encodeEntityCanvazRequest(trackUri);

      const res = await fetch("https://gue1-spclient.spotify.com/canvaz-cache/v0/canvases", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/x-protobuf",
        },
        body,
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const buffer = await res.arrayBuffer();
      const uint8array = new Uint8Array(buffer);
      const decoded = EntityCanvazResponse.decode(uint8array);
      return decoded.canvases.map(c => c.url).filter(Boolean);
    }

    function playCanvasVideos(urls) {
      if (urls.length === 0) return;
      let index = 0;
      canvasPlayer.src = urls[index];
      canvasPlayer.play();

      canvasPlayer.onended = () => {
        index = (index + 1) % urls.length;
        canvasPlayer.src = urls[index];
        canvasPlayer.play();
      };
    }

    let accessToken = getTokenFromUrl();
    if (accessToken) {
      clearUrlHash();
      loginSection.style.display = "none";
      mainSection.style.display = "block";

      try {
        const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
          headers: { Authorization: `Bearer ${accessToken}` }
        });

        if (!res.ok) {
          statusEl.textContent = `Không lấy được bài đang phát (HTTP ${res.status})`;
          return;
        }

        const data = await res.json();
        const trackId = data?.item?.id;
        if (!trackId) {
          statusEl.textContent = "Không có bài hát đang phát.";
          return;
        }

        statusEl.textContent = `Đang phát: ${data.item.name} - ${data.item.artists.map(a => a.name).join(", ")}`;
        const urls = await fetchCanvasUrls(accessToken, trackId);

        if (urls.length === 0) {
          statusEl.textContent += " (không có Canvas)";
          return;
        }

        urlsEl.textContent = urls.join("\n");
        playCanvasVideos(urls);

      } catch (e) {
        statusEl.textContent = "Lỗi: " + e.message;
        console.error(e);
      }

    } else {
      loginSection.style.display = "block";
    }

    loginBtn.onclick = () => {
      window.location.href = getSpotifyLoginUrl();
    };

  })();
  </script>
</body>
</html>
